# whitelist
branches:
  only:
    - master
sudo: required
services: 
  - docker
language: ruby
rvm:
  - 2.3.1
before_install:
  - export AUTHOR=`git --no-pager show -s --format='%an <%ae>'`
  - export DATE=`TZ=America/New_York date "+%m-%d-%y-%H%M"`
  - export DOCKER_IMAGE="matchbox/nci-treatment-arm-api"
script:
  - RAILS_ENV=test bundle exec rspec spec/
    #Build Docker image
  - docker build --build-arg buildnum=$TRAVIS_BUILD_NUMBER \  
      --build-arg traviscommit=$TRAVIS_COMMIT \ 
      --build-arg travisjobid=$TRAVIS_JOB_ID \ 
      --build-arg author=$AUTHOR \ 
      --build-arg dockerimage=$DOCKER_IMAGE \ 
      --build-arg date=$DATE \ 
      -t $DOCKER_IMAGE:$DATE -t $DOCKER_IMAGE:latest .
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  # - docker run -it --rm -e "RAILS_ENV=test" $DOCKER_IMAGE:$DATE 
  #     bundle exec rspec spec/
after_success:
  - bundle exec codeclimate-test-reporter
  - docker images
  - docker push $DOCKER_IMAGE # Pushes both date and latest
  #Deploy to AWS IntTest
  # - aws ecs update-service --cluster uMatch-Test --service uMatch-nci-treatment-arm-api-TEST --task-definition uMatch-nci-treatment-arm-api-TEST 
  - docker run -it --rm -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY 
    -e AWS_DEFAULT_REGION=us-east-1 silintl/ecs-deploy 
    --cluster PedMatch-IntTest-Backend2 --service-name PedMatch-nci-treatment-arm-api-INTTEST 
    -i $DOCKER_IMAGE:$DATE
  #Trigger Travis bdd tests
  - curl -s -X POST -H "Content-Type:application/json" -H "Accept:application/json" -H "Travis-API-Version:3" -H "Authorization:token $TRAVIS_TOKEN" -d "{\"request\":{\"message\":\"Triggered by nci-treatment-arm-api $TRAVIS_COMMIT\", \"branch\":\"master\", \"config\":{\"env\":{\"matrix\":[\"TRIGGER_REPO=nci-treatment-arm-api;TRIGGER_VER=$DATE;CUC_TAG=@treatment_arm\"]}}}}" https://api.travis-ci.org/repo/CBIIT%2Fnci-uMatch-bddtests/requests
notifications:
  slack: clinicalbiomed:gRp5LqKElNOjUUMPLlq4qC1j
addons:
  code_climate:
    repo_token: 265d803327b2e66971bf6df85cb05445913ec3164bd88d28d12de70added55bb
